---
# Preámbulo con paquetes y definiciones básicas
# Se incluyen los comandos mínimos de LaTeX
#title: Equipo4
author:
 - Andrés Arredondo Cruz (andresabstract@gmail.com)
 - Adriana Haydé Contreras Peruyero (haydeeperuyero@gmail.com)
 - David Alberto García Estrada (david.garcia.e@cinvestav.mx)
header-includes:
  - \usepackage{mathtools}
  - \usepackage{amsthm}
  - \usepackage{amssymb}
  - \usepackage{eufrak}
  - \usepackage{mathrsfs}
  - \usepackage{color}
  - \usepackage[spanish]{babel}
  - \usepackage{fancyhdr}
  - \usepackage{array}
  - \usepackage{subfigure} %para incluir mas de una figura en un solo espacio
  - \usepackage{graphicx}
  - \allowdisplaybreaks #% para permitir rompimiento de ecuaciones en p\'aginas distintas
    # ver http://tex.stackexchange.com/questions/51682/is-it-possible-to-pagebreak-aligned-equations
    # para m\'as detalles
  #- \numberwithin{equation}{section} # Para numerar ecuaciones por secciones cuando están numeradas
  # - \decimalpoint
  #- \usepackage{caption}
  - \usepackage{float}
  #- \usepackage[font=small,labelfont=bf]{caption}
  # para usar kableExtra se requieren los siguientes paquetes
  # ver
  # https://haozhu233.github.io/kableExtra/awesome_table_in_pdf.pdf
  # para más detalles
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  # Definir ambientes de Teorema
  - \newtheorem{teorema}{Teorema}
  - \newtheorem{lema}[teorema]{Lema}
  - \newtheorem{corolario}[teorema]{Corolario}
  - \newtheorem{proposicion}[teorema]{Proposici\'on}
  - \newtheorem{conjetura}[teorema]{Conjetura}
  - \newtheorem{definicion}{Definici\'on}
  - \newtheorem{ejemplo}[teorema]{Ejemplo}
  - \newtheorem{nota}{Nota}
  
output: 
  pdf_document:
    toc_depth: 2
    number_sections: true
    df_print: kable
    highlight: tango
---

\newcommand{\cb}{\color{blue}}
\newcommand{\cg}{\color{green}}
\newcommand{\cvi}{\color{violet}}


<!-- El siguiente código sirve para poner el logo del encabezado. -->
<!-- \pagestyle{fancy} -->
<!-- \fancyhf{} -->

<!-- \rhead{\begin{picture}(0,0)  -->
<!-- \put(-40,-40) %mover de posición la imagen -->
<!-- {\includegraphics[width=15mm] -->
<!-- {images/ccm-2}}  -->
<!-- \end{picture}} -->

<!-- \renewcommand{\headrulewidth}{0pt} -->
<!-- \rfoot[\thepage]{\vspace{-0.5cm} \thepage} -->


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r include = FALSE, echo = FALSE}
##  LIBRERÍAS
# Aquí vamos a incluir las librerías que necesitemos
# En donde se pongan pedazos de código, únicamente se comentará
# Es BUENA PRÁCTICA poner las librerías al principio, por ello las ponemos aquí
# Primero deben asegurarse de tener instalados todos los paquetes
#install.packages("kableExtra")
# library(library_name)
#library(knitr)
#library(readr)
library(ggplot2)
library(tidyverse)
#library(kableExtra)
library(phyloseq)
library(plyr)
#library(dplyr)
#library(factoextra)
library(vegan)
# tydiverse incluye ggplot2, readr, dplyr, etc 
```

<!-- AQUÍ INICIA LA PÁGINA DE TÍTULO
  Indicaciones:
          El nombre de los autores aparece al principio
-->

\title{ {\sc Escuela Nacional de Estudios Superiores Unidad León}\\
\vspace{1cm}{\sc Centro de Ciencias Matemáticas }\\ 
\vspace{1cm}{\sc UGA-LANGEBIO CINVESTAV}\\
  \vspace{1cm} {Análisis estadístico de datos de Microbioma con R}\\
   \vspace{1.5cm} {Capítulo 8: Análisis univariado de comunidades} \\[2cm]
       \vspace{1.5cm} {Equipo 4}\\
       }
  
\date{\vspace{5.5cm} Morelia\\
      \vspace{1cm} Septiembre de 2022}

 \maketitle
 

\thispagestyle{fancy}
\newpage

<!-- FIN DE LA PÁGINA DE  TÍTULO-->

<!-- INICIO ÍNDICE -->

\tableofcontents
\newpage
<!-- FIN INDICE -->



<!-- INICIO DOCUMENTO -->


# Introducción
## Análisis univariado de comunidades

Dividimos el estudio de la composición de las comunidades microbianas en dos grandes componentes: (a)Evaluación de hipótesis sobre diversidad taxonómica, OTU y Taxones  (b) Análisis de diferencias entre grupos. El primer componente pertenece principalmente a análisis univariado de comunidades. El segundo puede ser dividido en varias técnicas multivariadas, como lo son "clustering" y  "ordinations", y la evaluación de hipótesis de análisis multivariado de  disimilitudes.  

##8.1 Comparaciones de diversidades entre dos grupos

En nuestro estudio con ratones Vdr-/-, uno de los propósitos es probar la diferencia de diversidades entre dos grupos (Vdr-/- y ratones de tipo salvaje) en sitios fecales y cecales. Aquí ilustraremos el análisis de la comunidad univariante, y compararemos la diversidad de Shannon(calculado anteriormente en Cap. 6 en las muestras fecales) usando varias estadísticas de prueba.

##8.1.1 Prueba t de Welch para dos muestras

El estadístico t fue introducido en 1908 por William Sealy Gosset. Una prueba t de dos muestras se utiliza para probar que las medias de dos poblaciones son iguales. Se aplica más comúnmente cuando el estadístico de prueba seguiría una distribución normal. Si los dos grupos tienen la misma varianza, el estadístico t se puede calcular de la siguiente manera:
$$
t=\frac{\bar X_1 - \bar X_2}{^{Sp} \sqrt{\frac{1}{n_1}+\frac{1}{n_2}}}
$$
donde, sp y s22 son el estimador imparcial de la varianza de las muestras 1 y 2, respectivamente. Cuando las dos muestras tienen varianzas desiguales y tamaños de muestra desiguales, la prueba t de Welch se considera más confiable (Ruxton 2006).
Por lo tanto, aquí usamos la prueba t de Welch para nuestros datos de ratón Vdr-/-.
Primero, cargue y transponga el conjunto de datos:

```{r}
# IMPORTANTE
# Ajustamos path de trabajo según tu PC
path <- "C:/Users/ANDRESARREDONDOCRUZ/"
path <- paste0(path,"Equipo4/")
setwd(path)
```

```{r}
abund_table=read.csv(paste0(path,"data/VdrGenusCounts.csv"),row.names=1,check.names=FALSE)
abund_table<-t(abund_table)
```

Para incorporar la información del grupo del conjunto de datos directamente a la comparación, necesitamos administrar los datos. En el conjunto de datos, la información de id de muestra y grupo está en una franja de caracteres. Primero los extraemos de allí.

```{r}
grouping<-data.frame(row.names=rownames(abund_table),t(as.data.frame(strsplit(rownames(abund_table),"_"))))
grouping$Location <- with(grouping, ifelse(X3%in%"drySt-28F", "Fecal", "Cecal"))
grouping$Group <- with(grouping,ifelse(as.factor(X2)%in% c(11,12,13,14,15),c("Vdr-/-"), c("WT")))
grouping <- grouping[,c(4,5)]
grouping
```

Repetimos el calculo de la diversidad de Shannon para est tabla, igual que en el capitulo 6.

```{r}
#library(vegan)
H<-diversity(abund_table, "shannon") 
```

Luego combinamos dataframes de diversidad y agrupación para crear un nuevo dataframe.

```{r}
df_H<-data.frame(sample=names(H),value=H,measure=rep("Shannon",length(H)))
df_G <-cbind(df_H, grouping)
rownames(df_G)<-NULL
df_G
```

A continuación, creamos subconjuntos de datos fecales del nuevo dataframe.

```{r}
Fecal_G<- subset(df_G, Location=="Fecal")
Fecal_G
```

Ahora los datos están listos para el análisis estadístico. Antes de realizar la prueba de hipótesis, exploremos la distribución de los valores de diversidad de Shannon usando la función ggplot() 

```{r}
#library(ggplot2)
#dividimos el gráfico en dos paneles usando facet_grid.
p<-ggplot(Fecal_G, aes(x=value))+
  geom_histogram(color="black", fill="black")+
  facet_grid(Group ~ .)
```

El paquete plyr se utiliza para calcular los valores promedio de diversidad de Shannon de cada grupo

```{r}
#library(plyr)
#la función ddply toma input un df y arroja un df de output
mu <- ddply(Fecal_G, "Group", summarise, grp.mean=mean(value))
head(mu)

#Agregamos las líneas de la media a la gráfica

p+geom_vline(data=mu, aes(xintercept=grp.mean, color="red"),
             linetype="dashed")
```

En el histograma anterior la eliminación de Vdr de este grupo se desplaza hacia la derecha en relación con el grupo WT (hacia valores de diversidad más altos),  lo que da como resultado una mayor diversidad. 

```{r}
#Usamos la prueba t de Welch para probar la hipotesis nula
fit_t <- t.test(value ~ Group, data=Fecal_G)
fit_t
```

Para probar la hipótesis nula de que no hay diferencia en la diversidad de Shannon, se utilizó una prueba t de Welch que dio como resultado un valor de p = 0,01 (t = 3,6, df = 5,9). Por lo tanto, rechazamos la hipótesis nula de no diferencia a favor de la alternativa de que las diversidades de Shannon son diferentes en los dos grupos.

##8.2 Comparisons of a Taxon of Interest between Two Groups 
